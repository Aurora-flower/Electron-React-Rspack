/**
 * @file app æ¨¡å—ç›¸å…³å±æ€§ä¸äº‹ä»¶ç›‘å¬å¤„ç†åŠå®ä¾‹æ–¹æ³•
 * @description app æ¨¡å—ç›¸å…³äº‹ä»¶å¤„ç†å‡½æ•°ã€‚
 */
import { app } from 'electron';
import { sep, join } from 'node:path';
import { getPlatform } from './process';

/**
 * è·å– app æ¨¡å—çš„å±æ€§å€¼ã€‚
 * @description
 * - `accessibilitySupportEnabled`:
 *    - æ˜¯å¦å¯ç”¨ Chrome çš„è¾…åŠ©åŠŸèƒ½(æ— éšœç¢æ”¯æŒ)ï¼Œä¾‹å¦‚å±å¹•é˜…è¯»;
 *    - é»˜è®¤ä¸º `false`ï¼Œå°†æ­¤å±æ€§è®¾ç½®ä¸º `true` å¯å¯ç”¨æ”¯æŒï¼Œå…è®¸å¼€å‘äººå‘˜åœ¨åº”ç”¨ç¨‹åºè®¾ç½®ä¸­å‘ç”¨æˆ·å¼€æ”¾æ— éšœç¢åˆ‡æ¢;
 *    - **æ­¤ API å¿…é¡»åœ¨ ready äº‹ä»¶è§¦å‘åè°ƒç”¨**;
 *    - _**æ¸²æŸ“è®¿é—®æƒé™æ ‘å¯èƒ½ä¼šä¸¥é‡å½±å“åº”ç”¨çš„æ€§èƒ½**_;
 *    - ä»…æ”¯æŒ _`Windows`_ | _`MacOS`_
 *
 * - `applicationMenu`: è·å–æˆ–è®¾ç½®åº”ç”¨ç¨‹åºèœå•;
 *
 * - `badgeCount`:
 *    - è·å–æˆ–è®¾ç½®å½“å‰åº”ç”¨ç¨‹åºçš„å³ä¸Šè§’å¾½ç« è®¡æ•°(åº”ç”¨è§’æ ‡è®¡æ•°çš„ Integer å±æ€§);
 *    - å°†è®¡æ•°è®¾ç½®ä¸º `0` å°†éšè—è§’æ ‡;
 *    - ä»…æ”¯æŒ  _`Linux`_ | _`MacOS`_;
 *    - åœ¨ `macOS` ä¸Šï¼Œä¸ºè¯¥å±æ€§è®¾ç½®ä»»ä½•éé›¶æ•´æ•°ï¼Œä¼šæ˜¾ç¤ºåœ¨ `dock` å›¾æ ‡ä¸Š;
 *    - åœ¨ `Linux` ä¸Šï¼Œè¿™ä¸ªå±æ€§åªé€‚ç”¨äº Unity å¯åŠ¨å™¨ã€‚ä½†æ˜¯ï¼Œ`Unity` å¯åŠ¨å™¨éœ€è¦ä¸€ä¸ª `.desktop` æ–‡ä»¶æ‰èƒ½å·¥ä½œ;
 *    - åœ¨ `macOS` ä¸Šï¼Œä¸ºäº†ä½¿è¯¥å±æ€§ç”Ÿæ•ˆï¼Œéœ€è¦ç¡®ä¿åº”ç”¨ç¨‹åºå…·æœ‰æ˜¾ç¤ºé€šçŸ¥çš„æƒé™;
 *
 * - `commandLine`: (åªè¯») `CommandLine` å¯¹è±¡ï¼Œå…è®¸è¯»å–å’Œæ“ä½œ Chromium ä½¿ç”¨çš„å‘½ä»¤è¡Œå‚æ•°;
 *
 * - `dock`:
 *    - (åªè¯») `Dock` | `undefined` å¯¹è±¡ï¼Œå…è®¸åœ¨ macOS ä¸Šçš„ç”¨æˆ· dock ä¸­å¯¹åº”ç”¨å›¾æ ‡è¿›è¡Œæ“ä½œ;
 *    - ä»…æ”¯æŒ _`macOS`_
 *
 * - `isPackaged`:
 *    - (åªè¯») å¦‚æœåº”ç”¨ç¨‹åºåŒ…è¢«åˆ›å»ºï¼Œåˆ™è¿”å› `true`ï¼Œå¦åˆ™è¿”å› `false`;
 *    - å¯¹äºå¤§å¤šæ•°åº”ç”¨ç¨‹åºï¼Œæ­¤å±æ€§å¯ç”¨äºåŒºåˆ†å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒ;
 *
 * - `name`:
 *    - æŒ‡æ˜å½“å‰åº”ç”¨ç¨‹åºçš„åç§°ï¼Œå³åº”ç”¨ç¨‹åº `package.json` æ–‡ä»¶ä¸­çš„åç§°;
 *    - è·å–æˆ–è®¾ç½®åº”ç”¨ç¨‹åºçš„åç§°ï¼Œé»˜è®¤ä¸º `package.json` ä¸­çš„ `productName` æˆ– `name` å­—æ®µï¼Œ
 *      å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™é»˜è®¤ä¸º `process.execPath` çš„ basename;
 *    - æ ¹æ® npm çš„å‘½åè§„åˆ™, é€šå¸¸ `package.json` ä¸­çš„ `name` å­—æ®µæ˜¯ä¸€ä¸ªçŸ­çš„å°å†™å­—ç¬¦ä¸²ã€‚
 *      é€šå¸¸è¿˜åº”è¯¥æŒ‡å®šä¸€ä¸ª `productName` å­—æ®µ, æ˜¯é¦–å­—æ¯å¤§å†™çš„å®Œæ•´åç§°ï¼Œç”¨äºè¡¨ç¤ºåº”ç”¨ç¨‹åºçš„åç§°ã€‚
 *      Electron ä¼šä¼˜å…ˆä½¿ç”¨è¿™ä¸ªå­—æ®µä½œä¸ºåº”ç”¨åã€‚
 *
 * - `userAgentFallback`:
 *    - Electron ç”¨äºå…¨å±€å›é€€çš„ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²;
 *    - å½“ç”¨æˆ·ä»£ç†åœ¨ `webContents` æˆ– `session` çº§åˆ«æ²¡æœ‰è¢«è®¾ç½®æ—¶ï¼Œå°†ä½¿ç”¨æ­¤ç”¨æˆ·ä»£ç†ã€‚
 *      æœ‰åŠ©äºç¡®ä¿çš„æ•´ä¸ªåº”ç”¨ç¨‹åºå…·æœ‰ç›¸åŒçš„ç”¨æˆ·ä»£ç†ã€‚
 *      åœ¨åº”ç”¨åˆå§‹åŒ–ä¸­å°½æ—©è®¾ç½®ä¸ºè‡ªå®šä¹‰å€¼ï¼Œä»¥ç¡®ä¿ä½¿ç”¨çš„æ˜¯è¦†ç›–çš„å€¼ã€‚
 *    - è·å–æˆ–è®¾ç½®é»˜è®¤çš„ `User-Agent` å­—ç¬¦ä¸²ï¼Œé»˜è®¤ä¸º `Chromium` çš„ç‰ˆæœ¬å·ï¼Œ
 *      ä¾‹å¦‚ `Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) huaying/0.0.1 Chrome/128.0.6613.162 Electron/32.1.2 Safari/537.36`;
 *
 * - `runningUnderARM64Translation`:
 *    - è¡¨æ˜å½“å‰åº”ç”¨æ˜¯å¦æ­£åœ¨ä½¿ç”¨ `ARM64` è¿è¡Œç¯å¢ƒ (æ¯”å¦‚ macOS `Rosetta Translator Environment` æˆ–è€… Windows `WOW`);
 *    - å½“ç”¨æˆ·åœ¨ `Rosetta` æˆ– `WOW` ä¸‹é”™è¯¯åœ°è¿è¡Œ x64 ç‰ˆæœ¬æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æ­¤å±æ€§æç¤ºç”¨æˆ·ä¸‹è½½åº”ç”¨ç¨‹åºçš„ `arm64` ç‰ˆæœ¬ã€‚
 * @param prop å±æ€§åç§°
 * @returns å±æ€§å€¼
 */
export async function getAppProperty(
  prop: MainProcess.AppProperty
): Promise<unknown> {
  return app[prop];
}
/**
 * å¸¸è§„ç±»å‹äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œæä¾›æ·»åŠ å’Œç§»é™¤äº‹ä»¶ç›‘å¬å™¨çš„åŠŸèƒ½ã€‚
 * @param eventName äº‹ä»¶åç§°
 * @param Listener äº‹ä»¶ç›‘å¬
 * @returns è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨è¯¥å‡½æ•°å°†ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ã€‚
 */
export function routineFeature<T>(
  eventName: T,
  Listener: (...args: any) => unknown
) {
  app.on(eventName as any, Listener);

  // ç”¨äºç§»é™¤äº‹ä»¶ç›‘å¬å™¨
  return () => {
    app.off(eventName as any, Listener);
  };
}

/**
 * è·å–è¾“å‡ºè·¯å¾„
 * @param path è¾“å‡ºè·¯å¾„
 * @returns è¾“å‡ºè·¯å¾„
 */
export function getAppAsarOutput(path: string) {
  const AppAsar =
    app.getAppPath(); /* é¡¹ç›®è·¯å¾„ - æ‰“åŒ…åå¯¹åº”ç€çš„æ˜¯ app.asar */
  const baseOutput = app.isPackaged ? '' : 'app';
  return join(AppAsar, baseOutput, path);
}

/**
 * è·å–åº”ç”¨ç¨‹åºç›¸å…³è·¯å¾„ä¿¡æ¯
 * @returns åº”ç”¨è·¯å¾„ä¿¡æ¯å­—å…¸
 * @default {}
 */
export function getAppPaths(): Record<string, string | boolean> {
  try {
    const paths: {
      [key: string]: string | boolean;
    } = {
      /* æ˜¯å¦æ‰“åŒ… */
      packaged: app.isPackaged,

      /* æ–‡ä»¶è·¯å¾„åˆ†éš”ç¬¦ */
      sep,

      /* ç³»ç»Ÿå¹³å° */
      platform: getPlatform()
    };

    const about: Array<MainProcess.PathNames> = [
      'home', // ç”¨æˆ·ä¸»ç›®å½•
      'appData', // åº”ç”¨ç¨‹åºæ•°æ®ç›®å½•
      'userData', // ç”¨æˆ·æ•°æ®ç›®å½•
      'sessionData', // ä¼šè¯æ•°æ®ç›®å½•
      'temp', // ä¸´æ—¶æ–‡ä»¶ç›®å½•
      'exe', // å¯æ‰§è¡Œæ–‡ä»¶ç›®å½•
      'module', // æ¨¡å—ç›®å½•
      'desktop', // æ¡Œé¢ç›®å½•
      'documents', // æ–‡æ¡£ç›®å½•
      'downloads', // ä¸‹è½½ç›®å½•
      'music', // éŸ³ä¹ç›®å½•
      'pictures', // å›¾ç‰‡ç›®å½•
      'videos', // è§†é¢‘ç›®å½•
      // 'recent', // æœ€è¿‘è®¿é—®æ–‡ä»¶ç›®å½• - ä»…é™äº windows
      'logs' // æ—¥å¿—æ–‡ä»¶ç›®å½•
      // 'crashDumps' // ç³»ç»Ÿå´©æºƒè½¬å‚¨æ–‡ä»¶ç›®å½•
    ];

    for (let index = 0; index < about.length; index++) {
      const name = about[index];
      paths[name] = app.getPath(name);
    }

    // è‡ªå®šä¹‰å·¥ä½œç©ºé—´ä½ç½®
    paths.workspace = join(
      paths.appData as string,
      'com.huaying.app'
    );

    return paths;
  } catch (error) {
    console.error('getAppPath Error:', error);
    return {};
  }
}

/**
 * ç¦ç”¨ GPU åŠ é€Ÿ (å¯ç”¨ç¦»å±æ¸²æŸ“)
 * @description
 * åœ¨ Electron ä¸­ï¼Œâ€œç¦»å±æ¸²æŸ“â€ï¼ˆOffscreen Renderingï¼‰å¹¶ä¸æ˜¯æˆªå›¾çš„æ„æ€ï¼Œä½†å¯ä»¥ç”¨äºç”Ÿæˆæˆªå›¾ã€‚
 * ç¦»å±æ¸²æŸ“æ˜¯æŒ‡åœ¨ä¸€ä¸ªä¸å¯è§çš„çª—å£ä¸­æ¸²æŸ“ç½‘é¡µå†…å®¹ï¼Œå¹¶è·å–æ¸²æŸ“ç»“æœçš„è¿‡ç¨‹ã€‚
 * è¿™ç§æŠ€æœ¯å¸¸ç”¨äºåå°ä»»åŠ¡ï¼Œæ¯”å¦‚ç”Ÿæˆé¢„è§ˆå›¾ã€æŠ“å–ç½‘é¡µå†…å®¹ç­‰ã€‚
 *
 * ç¦»å±æ¸²æŸ“å…è®¸ä»¥ä½å›¾çš„æ–¹å¼æ¥è·å– BrowserWindow ä¸­çš„å†…å®¹ï¼Œæ‰€ä»¥å®ƒå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è¢«æ¸²æŸ“ï¼Œä¾‹å¦‚åœ¨3Dåœºæ™¯ä¸­çš„çº¹ç†ã€‚
 *
 * æ³¨æ„ğŸ“¢:
 * - æœ‰ä¸¤ç§æ¸²æŸ“æ¨¡å¼å¯ä»¥ä½¿ç”¨ï¼ˆè§ä¸‹ï¼‰ï¼Œåªæœ‰æœªæ¸²æŸ“åŒºåŸŸä¼ é€’åˆ° ç»˜å›¾ äº‹ä»¶æ‰èƒ½æé«˜æ•ˆç‡
 * - å¯ä»¥åœæ­¢/ç»§ç»­æ¸²æŸ“å¹¶è®¾ç½®å¸§é€Ÿç‡
 * - æœ€é«˜å¸§é€Ÿç‡ä¸º `240`ï¼Œå› ä¸ºæ›´é«˜çš„å€¼åªä¼šå¸¦æ¥æ€§èƒ½ä¸Šçš„æŸå¤±è€Œæ²¡æœ‰ä»»ä½•æ”¶ç›Š
 * - å½“ç½‘é¡µä¸Šæ²¡æœ‰å‘ç”Ÿä»»ä½•æƒ…å†µæ—¶ï¼Œä¸ä¼šç”Ÿæˆå¸§
 * - å±å¹•çª—å£å§‹ç»ˆåˆ›å»ºä¸º `æ— è¾¹æ¡†çª—å£`..
 *
 * æ¸²æŸ“æ¨¡å¼:
 * - GPUåŠ é€Ÿ
 * GPU åŠ é€Ÿæ¸²æŸ“æ„å‘³ç€ä½¿ç”¨GPUç”¨äºåˆæˆã€‚
 * è¿™ä¹Ÿå°±æ„å‘³ç€å¸§å¿…é¡»ä» GPU æ‹·è´è¿‡æ¥ï¼Œä»è€Œéœ€æ±‚æ›´å¤šçš„èµ„æºï¼Œå› æ­¤è¿™ä¼šæ¯”è½¯ä»¶è¾“å‡ºè®¾å¤‡æ›´æ…¢ã€‚ è¿™
 * ç§æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯æ”¯æŒ WebGL å’Œ 3D CSS åŠ¨ç”».
 *
 * - è½¯ä»¶è¾“å‡ºè®¾å¤‡
 * æ­¤æ¨¡å¼ä½¿ç”¨è½¯ä»¶è¾“å‡ºè®¾å¤‡åœ¨ CPU ä¸­æ¸²æŸ“ï¼Œå› æ­¤å¸§ ç”Ÿæˆçš„é€Ÿåº¦è¦å¿«å¾—å¤šã€‚ å› æ­¤ï¼Œæ­¤æ¨¡å¼ä¼˜å…ˆäº GPU åŠ é€Ÿæ¨¡å¼ã€‚
 *
 * - è‹¥è¦å¯ç”¨æ­¤æ¨¡å¼ï¼Œå¿…é¡»é€šè¿‡è°ƒç”¨ `app.disableHardwareAccelerationï¼ˆï¼‰` APIç¦ç”¨ GPU åŠ é€Ÿã€‚
 */
export function disableGPUAcceleration() {
  app.disableHardwareAcceleration(); // è¡¨ç¤ºä¸ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿ
}
